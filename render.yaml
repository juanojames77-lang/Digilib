services:
  - type: web
    name: digilib
    env: node
    region: singapore
    plan: free
    buildCommand: |
      # ========== INSTALL NODE.JS DEPENDENCIES ==========
      echo "üì¶ Installing Node.js dependencies..."
      npm install
      
      # ========== INSTALL PYTHON AND SYSTEM DEPENDENCIES ==========
      echo "üêç Installing Python and system dependencies..."
      apt-get update
      apt-get install -y \
        python3 \
        python3-pip \
        python3-dev \
        build-essential \
        libjpeg-dev \
        zlib1g-dev
      
      # ========== INSTALL PYTHON ML PACKAGES ==========
      echo "üìö Installing Python ML packages..."
      pip3 install pdfplumber==0.10.3
      pip3 install joblib==1.3.2
      pip3 install scikit-learn==1.3.2
      pip3 install numpy==1.24.4
      pip3 install pandas==2.0.3
      
      # ========== VERIFY INSTALLATION ==========
      echo "‚úÖ Verifying installation..."
      python3 -c "import pdfplumber; print('pdfplumber version:', pdfplumber.__version__)"
      python3 -c "import joblib; print('joblib installed')"
      python3 -c "import sklearn; print('sklearn version:', sklearn.__version__)"
      
      echo "üöÄ Build complete!"
    startCommand: node server.js
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: digilib-db
          property: connectionString
      - key: CLOUD_NAME
        sync: false
      - key: CLOUD_KEY
        sync: false
      - key: CLOUD_SECRET
        sync: false
      - key: SESSION_SECRET
        generateValue: true
      - key: NODE_ENV
        value: production

databases:
  - name: digilib-db
    databaseName: digilib
    user: digilib_user
    plan: free