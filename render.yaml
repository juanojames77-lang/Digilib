services:
  - type: web
    name: digilib
    env: node
    region: singapore
    plan: free
    buildCommand: |
      # ========== NODE.JS ==========
      echo "STEP 1: Installing Node.js dependencies..."
      npm install
      
      # ========== PYTHON INSTALLATION ==========
      echo "STEP 2: Setting up Python environment..."
      
      # Update package list and install Python
      apt-get update -y
      apt-get install -y python3 python3-pip python3-dev
      
      # Install system dependencies for pdfplumber
      apt-get install -y libjpeg-dev zlib1g-dev
      
      # ========== PYTHON PACKAGES ==========
      echo "STEP 3: Installing Python packages..."
      
      # Install each package individually
      pip3 install pdfplumber==0.10.3
      pip3 install joblib==1.3.2
      pip3 install scikit-learn==1.3.2
      pip3 install numpy==1.24.4
      
      # ========== VERIFICATION ==========
      echo "STEP 4: Verifying installation..."
      echo "--- Python Version ---"
      python3 --version
      echo "--- Installed Packages ---"
      pip3 list
      echo "--- Testing Imports ---"
      python3 -c "import pdfplumber; print('pdfplumber:', pdfplumber.__version__)"
      python3 -c "import joblib; print('joblib: OK')"
      
      echo "âœ… Build completed successfully!"
    startCommand: node server.js
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: digilib-db
          property: connectionString
      - key: CLOUD_NAME
        sync: false
      - key: CLOUD_KEY
        sync: false
      - key: CLOUD_SECRET
        sync: false
      - key: SESSION_SECRET
        generateValue: true
      - key: NODE_ENV
        value: production

databases:
  - name: digilib-db
    databaseName: digilib
    user: digilib_user
    plan: free