<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-store" />
<title>DIGILIB | Admin Analytics</title>

<link rel="stylesheet" href="/style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* BASE STYLES */
body{font-family:'Segoe UI',sans-serif;margin:0;background:#f4f6fb;transition:.3s}
a{text-decoration:none}

/* HEADER */
header{background:#3f51b5;color:#fff;padding:14px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000}
header h1{margin:0;font-size:22px}

/* PROFILE */
.profile-bubble{background:#fff;color:#3f51b5;padding:6px 14px;border-radius:30px;cursor:pointer;position:relative;font-weight:600}
.dropdown{display:none;position:absolute;right:0;margin-top:10px;background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden}
.dropdown a,.dropdown label{padding:10px 14px;display:block;color:#333}
.dropdown a:hover{background:#f0f0f0}

/* LAYOUT */
.wrapper{display:flex;min-height:100vh}

/* SIDEBAR */
.sidebar{width:260px;background:#1f2a60;color:#fff;padding:25px 20px;position:fixed;height:100%}
.brand{text-align:center;margin-bottom:30px}
.brand img{width:110px;max-width:100%;margin-bottom:15px}
.brand h2{margin:0;letter-spacing:2px;font-weight:800}
.nav a{display:flex;align-items:center;gap:12px;padding:12px 15px;border-radius:10px;color:#cfd3ff;margin-bottom:8px;transition:.3s;font-weight:500}
.nav a:hover{background:#2f3da1;color:#fff}
.nav a.active{background:#3f51b5;color:#fff;box-shadow:0 8px 20px rgba(63,81,181,.5)}

/* CONTENT */
.content{margin-left:260px;padding:30px;width:100%}
.card{background:#fff;padding:20px 25px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.08);margin-bottom:25px}

/* STATS */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px}
.stat{background:#3f51b5;color:#fff;padding:15px;border-radius:12px;text-align:center;transition:.3s}
.stat:hover{box-shadow:0 8px 20px rgba(63,81,181,.4)}

/* CHARTS */
canvas{margin-top:15px;max-height:250px;background:#f9f9f9;border-radius:10px;padding:10px}

/* FILTER */
.filter-container{margin-bottom:15px}
select{padding:6px 10px;border-radius:8px;border:1px solid #ccc}

/* DARK MODE */
.dark-mode{background:#121212;color:#eee}
.dark-mode .card{background:#1e1e1e}
.dark-mode .sidebar{background:#111}
.dark-mode th{background:#333}
.dark-mode button{background:#555}
.dark-mode .stat{background:#555;color:#fff}

/* MOBILE */
@media(max-width:768px){.sidebar{position:relative;width:100%;height:auto}.content{margin-left:0;padding:15px}canvas{max-height:200px}}
</style>
</head>

<body>
<header>
  <h1></h1>
  <div class="profile-bubble" id="profileBubble">
    <%= user %>
    <div class="dropdown" id="profileDropdown">
      <a href="/logout">Logout</a>
      <label><input type="checkbox" id="darkToggle"> Dark Mode</label>
    </div>
  </div>
</header>

<div class="wrapper">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <img src="/logo.png" alt="DIGILIB">
      <h2>DIGILIB</h2>
    </div>
    <nav class="nav">
      <a href="/admin" class="nav-link">ðŸ“¤ Upload PDFs</a>
      <a href="/admin/download-requests" class="nav-link">ðŸ“¥ Download Requests</a>
      <a href="/admin/analytics" class="nav-link active">ðŸ“Š Analytics</a>
    </nav>
  </aside>

  <!-- CONTENT -->
  <main class="content">

    <!-- STATS -->
    <div class="card">
      <h2>Overview</h2>
      <div class="stats">
        <div class="stat"><h2 id="totalPDFs">0</h2><p>Total PDFs</p></div>
        <div class="stat"><h2 id="publicPDFs">0</h2><p>Public PDFs</p></div>
        <div class="stat"><h2 id="privatePDFs">0</h2><p>Private PDFs</p></div>
      </div>
    </div>

    <!-- FILTER BY COURSE -->
    <div class="filter-container">
      <label>Filter PDFs by Course: </label>
      <select id="courseFilter">
        <option value="all">All</option>
        <% clusters.forEach((c,i)=>{ %>
          <option value="<%= i %>"><%= c %></option>
        <% }) %>
      </select>
    </div>

    <!-- CHARTS -->
    <div class="card">
      <h2>PDFs per Course</h2>
      <canvas id="courseChart"></canvas>
    </div>

    <div class="card">
      <h2>Download Requests Status</h2>
      <canvas id="downloadChart"></canvas>
    </div>

  </main>
</div>

<script>
// PROFILE DROPDOWN
const profileBubble = document.getElementById('profileBubble');
const profileDropdown = document.getElementById('profileDropdown');
profileBubble.onclick = ()=> { profileDropdown.style.display = profileDropdown.style.display==='block'?'none':'block'; };

// DARK MODE
const darkToggle = document.getElementById('darkToggle');
darkToggle.addEventListener('change', ()=> { document.body.classList.toggle('dark-mode', darkToggle.checked); });

// FETCH DATA
const clusters = <%- JSON.stringify(clusters) %>;
let allPDFsPerCourse = [];
let downloadCounts = {pending:0, accepted:0, rejected:0};
let courseChartInstance = null;
let downloadChartInstance = null;

async function fetchAnalytics(){
  const res = await fetch('/admin/analytics-data');
  const data = await res.json();

  // STATS
  document.getElementById('totalPDFs').textContent = data.summary.totalPDFs;
  document.getElementById('publicPDFs').textContent = data.summary.publicPDFs;
  document.getElementById('privatePDFs').textContent = data.summary.privatePDFs;

  // PDFs per course
  allPDFsPerCourse = data.pdfsPerCourse;

  // Download counts
  downloadCounts.pending = data.downloadStatus.find(d=>d.status==='pending')?.count || 0;
  downloadCounts.accepted = data.downloadStatus.find(d=>d.status==='accepted')?.count || 0;
  downloadCounts.rejected = data.downloadStatus.find(d=>d.status==='rejected')?.count || 0;

  updateCharts();
}

function updateCharts(filter='all'){
  // PDFs per Course chart
  const filtered = filter==='all' ? allPDFsPerCourse : allPDFsPerCourse.filter(p=>p.cluster==filter);
  const labels = filtered.map(p=>clusters[p.cluster]);
  const dataValues = filtered.map(p=>p.count);

  // Destroy previous chart if exists
  if(courseChartInstance) courseChartInstance.destroy();

  courseChartInstance = new Chart(document.getElementById('courseChart'), {
    type:'bar',
    data:{
      labels:labels,
      datasets:[{
        label:'PDFs',
        data:dataValues,
        backgroundColor:'#3f51b5'
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        tooltip:{
          callbacks:{
            label:function(context){
              return `${context.raw} PDFs`;
            }
          }
        }
      },
      scales:{y:{beginAtZero:true}}
    }
  });

  // Download Requests chart
  if(downloadChartInstance) downloadChartInstance.destroy();

  downloadChartInstance = new Chart(document.getElementById('downloadChart'), {
    type:'pie',
    data:{
      labels:['Pending','Accepted','Rejected'],
      datasets:[{
        data:[downloadCounts.pending, downloadCounts.accepted, downloadCounts.rejected],
        backgroundColor:['#ffc107','#3f51b5','#f44336']
      }]
    },
    options:{responsive:true, maintainAspectRatio:false}
  });
}

// Filter change
document.getElementById('courseFilter').addEventListener('change', e=>{
  updateCharts(e.target.value);
});

fetchAnalytics();

window.addEventListener('pageshow', function (event) {
  if (event.persisted) {
    // Page was loaded from back/forward cache
    window.location.reload();
  }
});
</script>


</body>
</html>
